version: '1.0'
steps:
    build-step:
        type: build
        image-name: codefreshio/nodejs-mysql-example
        dockerfile: Dockerfile
        working-directory: ${{initial-clone}}
        tag: latest

    gen-image:
        image: node:latest
        working-directory: ${{initial-clone}}
        commands:
            - npm install -g gulp

    unit-test:
        type: composition
        working-directory: ${{initial-clone}}
        composition:
            version: '2'
            services:
                db:
                  image: mysql:latest
                  ports:
                    - 3306
                  environment:
                    MYSQL_ROOT_PASSWORD: admin
                    MYSQL_USER: root
                    MYSQL_PASSWORD: admin
                    MYSQL_DATABASE: nodejs
        composition-candidates:
            test:
              image: ${{gen-image}}
              command: npm test